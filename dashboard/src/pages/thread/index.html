<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thread - UP Command</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <style>
    .thread-page { max-width: 900px; }
    .thread-header { margin-bottom: var(--space-6); }
    .thread-title { font-family: var(--font-display); font-size: var(--text-4xl); font-weight: var(--font-semibold); margin-bottom: var(--space-2); }
    .thread-subtitle { color: var(--text-secondary); }
    
    .thread-controls { display: flex; flex-wrap: wrap; gap: var(--space-4); margin-bottom: var(--space-6); align-items: center; }
    .filter-group { display: flex; gap: var(--space-2); flex-wrap: wrap; }
    .filter-btn { padding: var(--space-2) var(--space-4); font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--text-muted); background: transparent; border: 1px solid var(--border); border-radius: var(--radius-full); cursor: pointer; transition: all var(--transition-fast); }
    .filter-btn:hover { color: var(--text-secondary); border-color: var(--border-light); }
    .filter-btn.active { color: var(--accent); background: var(--accent-muted); border-color: var(--accent); }
    
    .search-box { position: relative; flex: 1; min-width: 200px; }
    .search-input { width: 100%; padding: var(--space-2) var(--space-4) var(--space-2) var(--space-10); background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-full); color: var(--text-primary); font-size: var(--text-sm); }
    .search-input:focus { outline: none; border-color: var(--accent); }
    .search-icon { position: absolute; left: var(--space-4); top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    
    .date-group { margin-bottom: var(--space-8); }
    .date-header { display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4); }
    .date-label { font-size: var(--text-sm); font-weight: var(--font-semibold); color: var(--text-muted); white-space: nowrap; }
    .date-line { flex: 1; height: 1px; background: var(--border); }
    
    .activity-item { display: flex; gap: var(--space-4); padding: var(--space-4); background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: var(--space-3); transition: all var(--transition-fast); }
    .activity-item:hover { border-color: var(--border-light); }
    .activity-item.unread { border-left: 3px solid var(--accent); }
    
    .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: var(--text-lg); flex-shrink: 0; }
    .activity-icon.checkin { background: var(--accent-muted); }
    .activity-icon.task { background: var(--success-muted); }
    .activity-icon.message { background: var(--info-muted); }
    .activity-icon.handoff { background: var(--warning-muted); }
    .activity-icon.worklog { background: linear-gradient(135deg, var(--accent-muted), var(--info-muted)); }
    
    .activity-content { flex: 1; min-width: 0; }
    .activity-header { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1); flex-wrap: wrap; }
    .activity-user { font-weight: var(--font-semibold); color: var(--text-primary); }
    .activity-action { color: var(--text-muted); font-size: var(--text-sm); }
    .activity-time { font-size: var(--text-xs); color: var(--text-muted); margin-left: auto; }
    
    .activity-body { font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6; }
    .activity-body p { margin-bottom: var(--space-2); }
    .activity-body p:last-child { margin-bottom: 0; }
    
    .activity-meta { display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-3); }
    
    .worklog-card { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card)); border: 1px solid var(--accent-muted); }
    .worklog-card .activity-icon { width: 48px; height: 48px; font-size: var(--text-xl); }
    .worklog-shipped { margin-top: var(--space-3); padding: var(--space-3); background: var(--bg-primary); border-radius: var(--radius-md); }
    .worklog-shipped-title { font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--text-muted); text-transform: uppercase; margin-bottom: var(--space-2); }
    .shipped-item { font-size: var(--text-sm); color: var(--text-secondary); padding: var(--space-1) 0; display: flex; align-items: center; gap: var(--space-2); }
    .shipped-item::before { content: '‚úì'; color: var(--success); }
    
    .expand-btn { background: none; border: none; color: var(--accent); font-size: var(--text-sm); cursor: pointer; padding: var(--space-2) 0; }
    .expand-btn:hover { text-decoration: underline; }
    
    .checkin-recap { margin-top: var(--space-3); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md); display: none; }
    .checkin-recap.expanded { display: block; }
    .checkin-recap pre { font-family: var(--font-body); white-space: pre-wrap; font-size: var(--text-sm); color: var(--text-secondary); }
    
    .load-more { text-align: center; padding: var(--space-6); }
    .empty-state { text-align: center; padding: var(--space-12); color: var(--text-muted); }
    .empty-icon { font-size: 3rem; margin-bottom: var(--space-4); }
    .loading-state { display: flex; align-items: center; justify-content: center; gap: var(--space-3); padding: var(--space-8); color: var(--text-muted); }
  </style>
</head>
<body>
  <script src="../../shared/api.js"></script>
  <script src="../../shared/auth.js"></script>
  <script src="../../shared/nav.js"></script>
  
  <script>
    let currentFilter = 'all';
    let currentOffset = 0;
    let isLoading = false;
    let hasMore = true;
    const LIMIT = 30;
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = requireAuth();
      if (!user) return;
      
      const main = initLayout('thread', { showThread: false });
      main.innerHTML = `
        <div class="thread-page">
          <header class="thread-header">
            <h1 class="thread-title">üí¨ Thread</h1>
            <p class="thread-subtitle">Your activity stream - check-ins, completions, messages, and more</p>
          </header>
          
          <div class="thread-controls">
            <div class="filter-group">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="checkin">üìù Check-ins</button>
              <button class="filter-btn" data-filter="worklog">üìö Work Logs</button>
              <button class="filter-btn" data-filter="task">‚úÖ Completions</button>
              <button class="filter-btn" data-filter="message">üí¨ Messages</button>
              <button class="filter-btn" data-filter="handoff">üîÑ Handoffs</button>
            </div>
            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text" class="search-input" placeholder="Search activity..." id="search-input">
            </div>
          </div>
          
          <div id="thread-content">
            <div class="loading-state"><div class="spinner"></div><span>Loading activity...</span></div>
          </div>
          
          <div class="load-more" id="load-more" style="display: none;">
            <button class="btn btn-secondary" onclick="loadMore()">Load More</button>
          </div>
        </div>
      `;
      
      initFilters();
      initSearch();
      await loadThread();
    });
    
    function initFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          currentOffset = 0;
          hasMore = true;
          await loadThread();
        });
      });
    }
    
    function initSearch() {
      let timeout;
      document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
          currentOffset = 0;
          hasMore = true;
          await loadThread(e.target.value);
        }, 300);
      });
    }
    
    async function loadThread(search = '') {
      if (isLoading) return;
      isLoading = true;
      
      const container = document.getElementById('thread-content');
      const loadMoreBtn = document.getElementById('load-more');
      
      if (currentOffset === 0) {
        container.innerHTML = '<div class="loading-state"><div class="spinner"></div><span>Loading...</span></div>';
      }
      
      try {
        const params = new URLSearchParams({ limit: LIMIT, offset: currentOffset });
        if (currentFilter !== 'all') {
          const typeMap = {
            checkin: 'checkin',
            worklog: 'worklog',
            task: 'task_complete',
            message: 'message',
            handoff: 'handoff_created,handoff_complete,handoff_blocked,handoff_claimed'
          };
          params.set('types', typeMap[currentFilter]);
        }
        if (search) params.set('search', search);
        
        const res = await apiGet(`/api/activity?${params}`);
        const items = res.data || [];
        
        hasMore = items.length >= LIMIT;
        loadMoreBtn.style.display = hasMore ? 'block' : 'none';
        
        if (items.length === 0 && currentOffset === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üí§</div>
              <h3>No activity yet</h3>
              <p>Activity will appear here as you and your team work.</p>
            </div>
          `;
          return;
        }
        
        const html = renderActivityItems(items);
        if (currentOffset === 0) {
          container.innerHTML = html;
        } else {
          container.insertAdjacentHTML('beforeend', html);
        }
        
        currentOffset += items.length;
      } catch (err) {
        console.error('Failed to load thread:', err);
        if (currentOffset === 0) {
          container.innerHTML = '<div class="empty-state"><p class="text-danger">Failed to load activity</p></div>';
        }
      } finally {
        isLoading = false;
      }
    }
    
    async function loadMore() {
      await loadThread(document.getElementById('search-input').value);
    }
    
    function renderActivityItems(items) {
      const grouped = groupByDate(items);
      return Object.entries(grouped).map(([date, dateItems]) => `
        <div class="date-group">
          <div class="date-header">
            <span class="date-label">${date}</span>
            <span class="date-line"></span>
          </div>
          ${dateItems.map(item => renderActivityItem(item)).join('')}
        </div>
      `).join('');
    }
    
    function renderActivityItem(item) {
      const config = {
        checkin: { icon: 'üìù', class: 'checkin', action: 'checked in' },
        worklog: { icon: 'üìö', class: 'worklog', action: 'logged work' },
        task_complete: { icon: '‚úÖ', class: 'task', action: 'completed' },
        task_created: { icon: '‚ûï', class: 'task', action: 'created' },
        message: { icon: 'üí¨', class: 'message', action: 'sent a message' },
        handoff_created: { icon: 'üì§', class: 'handoff', action: 'created handoff' },
        handoff_claimed: { icon: 'ü§ù', class: 'handoff', action: 'claimed' },
        handoff_complete: { icon: 'üì•', class: 'handoff', action: 'completed handoff' },
        handoff_blocked: { icon: 'üö´', class: 'handoff', action: 'blocked' }
      };
      const c = config[item.type] || { icon: '‚Ä¢', class: '', action: '' };
      const isWorklog = item.type === 'worklog';
      const isCheckin = item.type === 'checkin';
      
      return `
        <div class="activity-item ${isWorklog ? 'worklog-card' : ''} ${item.unread ? 'unread' : ''}">
          <div class="activity-icon ${c.class}">${c.icon}</div>
          <div class="activity-content">
            <div class="activity-header">
              <span class="activity-user">${item.user || 'You'}</span>
              <span class="activity-action">${c.action}</span>
              <span class="activity-time">${formatTime(item.created_at)}</span>
            </div>
            <div class="activity-body">
              ${item.summary ? `<p>${escapeHtml(item.summary)}</p>` : ''}
              ${isWorklog && item.narrative ? `<p>${escapeHtml(item.narrative)}</p>` : ''}
            </div>
            ${item.project ? `
              <div class="activity-meta">
                <span class="badge badge-accent">${escapeHtml(item.project)}</span>
              </div>
            ` : ''}
            ${isWorklog && item.shipped?.length ? `
              <div class="worklog-shipped">
                <div class="worklog-shipped-title">Shipped</div>
                ${item.shipped.map(s => `<div class="shipped-item">${escapeHtml(s)}</div>`).join('')}
              </div>
            ` : ''}
            ${isCheckin && item.full_recap ? `
              <button class="expand-btn" onclick="toggleRecap(this)">Show full recap ‚ñº</button>
              <div class="checkin-recap"><pre>${escapeHtml(item.full_recap)}</pre></div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    function toggleRecap(btn) {
      const recap = btn.nextElementSibling;
      const isExpanded = recap.classList.toggle('expanded');
      btn.textContent = isExpanded ? 'Hide recap ‚ñ≤' : 'Show full recap ‚ñº';
    }
    
    function groupByDate(items) {
      const groups = {};
      const today = new Date().toDateString();
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      
      items.forEach(item => {
        const date = new Date(item.created_at);
        const dateStr = date.toDateString();
        const label = dateStr === today ? 'Today' :
                      dateStr === yesterday ? 'Yesterday' :
                      date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        if (!groups[label]) groups[label] = [];
        groups[label].push(item);
      });
      return groups;
    }
    
    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }
    
    function escapeHtml(t) {
      if (!t) return '';
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }
  </script>
</body>
</html>
