<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - UP Command</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <style>
    .settings-header {
      margin-bottom: var(--space-8);
    }
    
    .settings-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-2);
    }
    
    .settings-subtitle {
      color: var(--text-secondary);
      font-size: var(--text-base);
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-6);
      max-width: 800px;
    }
    
    .settings-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      overflow: hidden;
    }
    
    .section-header {
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .section-icon {
      font-size: 1.25rem;
    }
    
    .section-title {
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
    }
    
    .section-body {
      padding: var(--space-6);
    }
    
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) 0;
      border-bottom: 1px solid var(--border);
    }
    
    .setting-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .setting-row:first-child {
      padding-top: 0;
    }
    
    .setting-info {
      flex: 1;
      min-width: 0;
    }
    
    .setting-label {
      font-weight: var(--font-medium);
      margin-bottom: var(--space-1);
    }
    
    .setting-description {
      font-size: var(--text-sm);
      color: var(--text-muted);
    }
    
    .setting-control {
      flex-shrink: 0;
      margin-left: var(--space-4);
    }
    
    /* Profile Card */
    .profile-card {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-hover);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-4);
    }
    
    .profile-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      font-weight: var(--font-bold);
      color: var(--bg-primary);
    }
    
    .profile-info {
      flex: 1;
    }
    
    .profile-name {
      font-family: var(--font-display);
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      margin-bottom: var(--space-1);
    }
    
    .profile-role {
      font-size: var(--text-sm);
      color: var(--text-muted);
    }
    
    /* Teammate Card */
    .teammate-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .teammate-card {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--bg-hover);
      border-radius: var(--radius-lg);
    }
    
    .teammate-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-active);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-semibold);
      color: var(--text-secondary);
    }
    
    .teammate-info {
      flex: 1;
    }
    
    .teammate-name {
      font-weight: var(--font-medium);
    }
    
    .teammate-status {
      font-size: var(--text-xs);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .status-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    
    .status-indicator.online {
      background: var(--success);
    }
    
    /* Toggle Switch */
    .toggle {
      position: relative;
      width: 48px;
      height: 26px;
      background: var(--bg-active);
      border-radius: 13px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .toggle.active {
      background: var(--success);
    }
    
    .toggle-handle {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all var(--transition-fast);
    }
    
    .toggle.active .toggle-handle {
      left: 25px;
    }
    
    /* Select Dropdown */
    .select-wrapper {
      position: relative;
    }
    
    .select-wrapper select {
      appearance: none;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-2) var(--space-8) var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      color: var(--text-primary);
      cursor: pointer;
      min-width: 150px;
    }
    
    .select-wrapper::after {
      content: '‚ñº';
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--text-muted);
      pointer-events: none;
    }
    
    /* Export Buttons */
    .export-buttons {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    
    .export-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      color: var(--text-primary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .export-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-light);
    }
    
    .export-btn .icon {
      font-size: 1rem;
    }
    
    /* Version Info */
    .version-info {
      margin-top: var(--space-8);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      text-align: center;
    }
    
    .version-info p {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-bottom: var(--space-1);
    }
    
    .version-info a {
      color: var(--accent);
      text-decoration: none;
    }
    
    .version-info a:hover {
      text-decoration: underline;
    }
    
    /* Loading & Toast */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-8);
      color: var(--text-muted);
    }
    
    .toast {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: all var(--transition-base);
      z-index: 1000;
    }
    
    .toast.visible {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      border-color: var(--success);
    }
    
    .toast.error {
      border-color: var(--danger);
    }
    
    /* Danger Zone */
    .danger-zone {
      border-color: var(--danger-muted);
    }
    
    .danger-zone .section-header {
      background: var(--danger-muted);
      border-bottom-color: var(--danger-muted);
    }
    
    .danger-zone .section-title {
      color: var(--danger);
    }
  </style>
</head>
<body>
  <script src="../../shared/api.js"></script>
  <script src="../../shared/auth.js"></script>
  <script src="../../shared/nav.js"></script>
  
  <script>
    // User data
    const USERS = {
      micaiah: { name: 'Micaiah', role: 'Builder & Operator', initial: 'M' },
      irene: { name: 'Irene', role: 'Creative Director', initial: 'I' }
    };
    
    // Preferences (stored in localStorage)
    const DEFAULT_PREFS = {
      defaultCategory: '',
      threadSidebarOpen: true,
      notifyTaskComplete: true,
      notifyMessages: true,
      notifyHandoffs: true
    };
    
    let currentUser = null;
    let preferences = { ...DEFAULT_PREFS };
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = requireAuth();
      if (!user) return;
      
      currentUser = user;
      loadPreferences();
      
      const main = initLayout('settings', { showThread: false });
      renderPage();
    });
    
    function loadPreferences() {
      const saved = localStorage.getItem('up_preferences');
      if (saved) {
        try {
          preferences = { ...DEFAULT_PREFS, ...JSON.parse(saved) };
        } catch (e) {
          console.error('Failed to parse preferences:', e);
        }
      }
    }
    
    function savePreferences() {
      localStorage.setItem('up_preferences', JSON.stringify(preferences));
      showToast('Settings saved', 'success');
    }
    
    function renderPage() {
      const main = document.querySelector('main');
      const userData = USERS[currentUser.id] || { name: currentUser.id, role: 'Team Member', initial: currentUser.id[0].toUpperCase() };
      const teammate = currentUser.id === 'micaiah' ? USERS.irene : USERS.micaiah;
      const teammateId = currentUser.id === 'micaiah' ? 'irene' : 'micaiah';
      
      main.innerHTML = `
        <header class="settings-header">
          <h1 class="settings-title">‚öôÔ∏è Settings</h1>
          <p class="settings-subtitle">Manage your account and preferences</p>
        </header>
        
        <div class="settings-grid">
          <!-- Profile Section -->
          <section class="settings-section">
            <div class="section-header">
              <span class="section-icon">üë§</span>
              <h2 class="section-title">Profile</h2>
            </div>
            <div class="section-body">
              <div class="profile-card">
                <div class="profile-avatar">${userData.initial}</div>
                <div class="profile-info">
                  <div class="profile-name">${userData.name}</div>
                  <div class="profile-role">${userData.role}</div>
                </div>
              </div>
              
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">User ID</div>
                  <div class="setting-description">${currentUser.id}</div>
                </div>
              </div>
              
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Session</div>
                  <div class="setting-description">Logged in ‚Ä¢ Expires in 7 days</div>
                </div>
                <div class="setting-control">
                  <button class="btn btn-secondary btn-sm" onclick="handleLogout()">Log Out</button>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Team Section -->
          <section class="settings-section">
            <div class="section-header">
              <span class="section-icon">üë•</span>
              <h2 class="section-title">Team</h2>
            </div>
            <div class="section-body">
              <div class="teammate-list">
                <div class="teammate-card">
                  <div class="teammate-avatar">${teammate.initial}</div>
                  <div class="teammate-info">
                    <div class="teammate-name">${teammate.name}</div>
                    <div class="teammate-status">
                      <span class="status-indicator online"></span>
                      <span>${teammate.role}</span>
                    </div>
                  </div>
                  <a href="../thread/?with=${teammateId}" class="btn btn-secondary btn-sm">Message</a>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Preferences Section -->
          <section class="settings-section">
            <div class="section-header">
              <span class="section-icon">üé®</span>
              <h2 class="section-title">Preferences</h2>
            </div>
            <div class="section-body">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Default Task Category</div>
                  <div class="setting-description">New tasks will be assigned to this category</div>
                </div>
                <div class="setting-control">
                  <div class="select-wrapper">
                    <select id="pref-default-category" onchange="updatePreference('defaultCategory', this.value)">
                      <option value="">None</option>
                      <option value="Development" ${preferences.defaultCategory === 'Development' ? 'selected' : ''}>Development</option>
                      <option value="Content" ${preferences.defaultCategory === 'Content' ? 'selected' : ''}>Content</option>
                      <option value="Marketing" ${preferences.defaultCategory === 'Marketing' ? 'selected' : ''}>Marketing</option>
                      <option value="Operations" ${preferences.defaultCategory === 'Operations' ? 'selected' : ''}>Operations</option>
                      <option value="Personal" ${preferences.defaultCategory === 'Personal' ? 'selected' : ''}>Personal</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Thread Sidebar</div>
                  <div class="setting-description">Show activity sidebar by default on dashboard pages</div>
                </div>
                <div class="setting-control">
                  <div class="toggle ${preferences.threadSidebarOpen ? 'active' : ''}" onclick="togglePreference('threadSidebarOpen', this)">
                    <div class="toggle-handle"></div>
                  </div>
                </div>
              </div>
              
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Theme</div>
                  <div class="setting-description">Color scheme for the interface</div>
                </div>
                <div class="setting-control">
                  <div class="select-wrapper">
                    <select disabled>
                      <option selected>Dark</option>
                      <option>Light (coming soon)</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Notifications Section -->
          <section class="settings-section">
            <div class="section-header">
              <span class="section-icon">üîî</span>
              <h2 class="section-title">Notifications</h2>
            </div>
            <div class="section-body">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Task Completions</div>
                  <div class="setting-description">Notify when tasks are completed</div>
                </div>
                <div class="setting-control">
                  <div class="toggle ${preferences.notifyTaskComplete ? 'active' : ''}" onclick="togglePreference('notifyTaskComplete', this)">
                    <div class="toggle-handle"></div>
                  </div>
                </div>
              </div>
              
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">New Messages</div>
                  <div class="setting-description">Notify when you receive messages from teammates</div>
                </div>
                <div class="setting-control">
                  <div class="toggle ${preferences.notifyMessages ? 'active' : ''}" onclick="togglePreference('notifyMessages', this)">
                    <div class="toggle-handle"></div>
                  </div>
                </div>
              </div>
              
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Handoff Updates</div>
                  <div class="setting-description">Notify when handoff tasks change status</div>
                </div>
                <div class="setting-control">
                  <div class="toggle ${preferences.notifyHandoffs ? 'active' : ''}" onclick="togglePreference('notifyHandoffs', this)">
                    <div class="toggle-handle"></div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Data Section -->
          <section class="settings-section">
            <div class="section-header">
              <span class="section-icon">üì¶</span>
              <h2 class="section-title">Data</h2>
            </div>
            <div class="section-body">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Export Data</div>
                  <div class="setting-description">Download your data as CSV files</div>
                </div>
                <div class="setting-control">
                  <div class="export-buttons">
                    <button class="export-btn" onclick="exportTasks()">
                      <span class="icon">üìã</span>
                      <span>Tasks</span>
                    </button>
                    <button class="export-btn" onclick="exportJournal()">
                      <span class="icon">üìî</span>
                      <span>Journal</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Danger Zone -->
          <section class="settings-section danger-zone">
            <div class="section-header">
              <span class="section-icon">‚ö†Ô∏è</span>
              <h2 class="section-title">Danger Zone</h2>
            </div>
            <div class="section-body">
              <div class="setting-row">
                <div class="setting-info">
                  <div class="setting-label">Clear Local Data</div>
                  <div class="setting-description">Clear cached data and preferences (won't delete server data)</div>
                </div>
                <div class="setting-control">
                  <button class="btn btn-danger btn-sm" onclick="clearLocalData()">Clear Data</button>
                </div>
              </div>
            </div>
          </section>
        </div>
        
        <div class="version-info">
          <p>UP Command Center v1.0.0</p>
          <p>
            <a href="https://github.com/mrmicaiah/up-command" target="_blank">GitHub</a> ‚Ä¢
            <a href="../../docs/" target="_blank">Documentation</a>
          </p>
        </div>
        
        <div class="toast" id="toast">
          <span class="toast-icon">‚úì</span>
          <span class="toast-message"></span>
        </div>
      `;
    }
    
    function updatePreference(key, value) {
      preferences[key] = value;
      savePreferences();
    }
    
    function togglePreference(key, element) {
      preferences[key] = !preferences[key];
      element.classList.toggle('active', preferences[key]);
      savePreferences();
    }
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.querySelector('.toast-message').textContent = message;
      toast.className = `toast ${type}`;
      toast.querySelector('.toast-icon').textContent = type === 'success' ? '‚úì' : '‚úï';
      
      // Show toast
      setTimeout(() => toast.classList.add('visible'), 10);
      
      // Hide after 3 seconds
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }
    
    function handleLogout() {
      if (confirm('Are you sure you want to log out?')) {
        logout();
      }
    }
    
    async function exportTasks() {
      try {
        showToast('Preparing export...', 'success');
        
        const { tasks } = await Tasks.list({ status: 'all', limit: 1000 });
        
        if (!tasks || tasks.length === 0) {
          showToast('No tasks to export', 'error');
          return;
        }
        
        // Convert to CSV
        const headers = ['id', 'text', 'status', 'priority', 'project', 'category', 'due_date', 'created_at', 'completed_at'];
        const csv = [
          headers.join(','),
          ...tasks.map(task => headers.map(h => {
            const val = task[h] || '';
            // Escape quotes and wrap in quotes if contains comma
            return val.toString().includes(',') ? `"${val.replace(/"/g, '""')}"` : val;
          }).join(','))
        ].join('\n');
        
        downloadFile(csv, `tasks-export-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        showToast('Tasks exported successfully', 'success');
      } catch (err) {
        console.error('Export failed:', err);
        showToast('Export failed', 'error');
      }
    }
    
    async function exportJournal() {
      try {
        showToast('Preparing export...', 'success');
        
        const entries = await Journal.list({ days: 365 });
        const journalEntries = entries?.entries || entries || [];
        
        if (!journalEntries || journalEntries.length === 0) {
          showToast('No journal entries to export', 'error');
          return;
        }
        
        // Convert to CSV
        const headers = ['id', 'content', 'entry_type', 'mood', 'energy', 'created_at'];
        const csv = [
          headers.join(','),
          ...journalEntries.map(entry => headers.map(h => {
            let val = entry[h] || '';
            // Escape quotes and handle newlines
            val = val.toString().replace(/"/g, '""').replace(/\n/g, ' ');
            return val.includes(',') || val.includes('\n') ? `"${val}"` : val;
          }).join(','))
        ].join('\n');
        
        downloadFile(csv, `journal-export-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        showToast('Journal exported successfully', 'success');
      } catch (err) {
        console.error('Export failed:', err);
        showToast('Export failed', 'error');
      }
    }
    
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function clearLocalData() {
      if (confirm('This will clear all local preferences and cached data. You will need to log in again. Continue?')) {
        // Clear preferences
        localStorage.removeItem('up_preferences');
        
        // Clear other cached data but NOT auth
        const authToken = localStorage.getItem('up_auth_token');
        const userId = localStorage.getItem('up_user_id');
        const authExpiry = localStorage.getItem('up_auth_expiry');
        
        // Clear everything
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('up_') && !['up_auth_token', 'up_user_id', 'up_auth_expiry'].includes(key)) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Reset preferences
        preferences = { ...DEFAULT_PREFS };
        
        showToast('Local data cleared', 'success');
        
        // Re-render
        setTimeout(() => renderPage(), 500);
      }
    }
  </script>
</body>
</html>