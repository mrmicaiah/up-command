<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courier - UP Command</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <link rel="stylesheet" href="courier.css">
</head>
<body>
  <script src="../../shared/api.js"></script>
  <script src="../../shared/auth.js"></script>
  <script src="../../shared/nav.js"></script>
  <script src="courier-api.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const user = requireAuth();
      if (!user) return;
      
      const main = initLayout('courier', { showThread: false });
      main.innerHTML = renderPage();
      
      if (!getCourierToken()) {
        showCourierLogin(loadData);
      } else {
        await loadData();
      }
    });
    
    function renderPage() {
      return `
        <header class="courier-header">
          <h1 class="courier-title">ğŸ“§ Courier</h1>
          <p class="courier-subtitle">Email marketing and automation</p>
          <nav class="courier-nav">
            <a href="index.html" class="courier-nav-item active">Overview</a>
            <a href="lists.html" class="courier-nav-item">Lists</a>
            <a href="campaigns.html" class="courier-nav-item">Campaigns</a>
            <a href="sequences.html" class="courier-nav-item">Sequences</a>
            <a href="subscribers.html" class="courier-nav-item">Subscribers</a>
          </nav>
        </header>
        
        <div class="quick-actions">
          <button class="btn btn-primary" onclick="location.href='campaigns.html?new=1'">âœ‰ï¸ New Campaign</button>
          <button class="btn btn-secondary" onclick="location.href='lists.html?new=1'">ğŸ“‹ New List</button>
          <button class="btn btn-ghost" onclick="courierLogout()" style="margin-left: auto;">ğŸšª Logout</button>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Subscribers</div>
            <div class="stat-value text-accent" id="stat-subscribers"><div class="spinner spinner-sm"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Email Lists</div>
            <div class="stat-value" id="stat-lists"><div class="spinner spinner-sm"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Campaigns Sent</div>
            <div class="stat-value text-success" id="stat-campaigns"><div class="spinner spinner-sm"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Open Rate</div>
            <div class="stat-value text-info" id="stat-open-rate"><div class="spinner spinner-sm"></div></div>
          </div>
        </div>
        
        <div class="main-grid">
          <div class="section-card">
            <div class="section-header">
              <h2 class="section-title">ğŸ“‹ Email Lists</h2>
              <a href="lists.html" class="text-accent text-sm">View All â†’</a>
            </div>
            <div id="lists-container">
              <div class="loading-placeholder"><div class="spinner spinner-sm"></div><span>Loading...</span></div>
            </div>
          </div>
          
          <div class="section-card">
            <div class="section-header">
              <h2 class="section-title">ğŸ”„ Sequences</h2>
              <a href="sequences.html" class="text-accent text-sm">View All â†’</a>
            </div>
            <div id="sequences-container">
              <div class="loading-placeholder"><div class="spinner spinner-sm"></div><span>Loading...</span></div>
            </div>
          </div>
          
          <div class="section-card" style="grid-column: span 2;">
            <div class="section-header">
              <h2 class="section-title">ğŸ“¨ Recent Campaigns</h2>
              <a href="campaigns.html" class="text-accent text-sm">View All â†’</a>
            </div>
            <div id="campaigns-container">
              <div class="loading-placeholder"><div class="spinner spinner-sm"></div><span>Loading...</span></div>
            </div>
          </div>
        </div>
      `;
    }
    
    async function loadData() {
      await Promise.all([
        loadStats(),
        loadLists(),
        loadSequences(),
        loadCampaigns()
      ]);
    }
    
    async function loadStats() {
      try {
        // Fetch stats and lists/campaigns to calculate totals
        const [stats, listsRes, campaignsRes] = await Promise.all([
          CourierAPI.stats(),
          CourierAPI.lists(),
          CourierAPI.campaigns()
        ]);
        
        // Calculate total subscribers from lists data
        const lists = listsRes.lists || stats.lists || [];
        const totalSubscribers = lists.reduce((sum, list) => sum + (list.subscribers || list.subscriber_count || 0), 0);
        
        // Count lists
        const totalLists = lists.length;
        
        // Count sent campaigns from emails array
        const campaigns = campaignsRes.emails || [];
        const sentCampaigns = campaigns.filter(c => c.status === 'sent').length;
        
        // Calculate open rate from email stats if available
        let avgOpenRate = 0;
        if (stats.emails && Array.isArray(stats.emails)) {
          // emails is [{status: 'sent', count: X}, {status: 'draft', count: Y}, ...]
          const sentCount = stats.emails.find(e => e.status === 'sent')?.count || 0;
          // For now, we don't have open tracking data in stats, show 0
          avgOpenRate = 0;
        }
        
        document.getElementById('stat-subscribers').textContent = formatNumber(totalSubscribers);
        document.getElementById('stat-lists').textContent = totalLists;
        document.getElementById('stat-campaigns').textContent = sentCampaigns;
        document.getElementById('stat-open-rate').textContent = avgOpenRate.toFixed(1) + '%';
      } catch (err) {
        console.error('Stats error:', err);
        ['stat-subscribers', 'stat-lists', 'stat-campaigns', 'stat-open-rate'].forEach(id => {
          document.getElementById(id).textContent = '-';
        });
      }
    }
    
    async function loadLists() {
      const container = document.getElementById('lists-container');
      try {
        const result = await CourierAPI.lists();
        const lists = result.lists || [];
        
        if (lists.length === 0) {
          container.innerHTML = `<div class="empty-state"><p>No email lists yet</p></div>`;
          return;
        }
        
        container.innerHTML = lists.slice(0, 5).map(list => `
          <div class="list-item" onclick="location.href='lists.html?id=${list.id}'">
            <div class="list-icon">ğŸ“§</div>
            <div class="list-content">
              <div class="list-name">${escapeHtml(list.name)}</div>
              <div class="list-meta">${list.subscriber_count || list.subscribers || 0} subscribers</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Lists error:', err);
        container.innerHTML = `<p class="text-danger text-sm p-4">Failed to load</p>`;
      }
    }
    
    async function loadSequences() {
      const container = document.getElementById('sequences-container');
      try {
        const result = await CourierAPI.sequences();
        const sequences = result.sequences || [];
        
        if (sequences.length === 0) {
          container.innerHTML = `<div class="empty-state"><p>No sequences yet</p></div>`;
          return;
        }
        
        container.innerHTML = sequences.slice(0, 5).map(seq => `
          <div class="sequence-item" onclick="location.href='sequences.html?id=${seq.id}'">
            <div class="sequence-status ${seq.status || 'draft'}"></div>
            <div class="sequence-content">
              <div class="sequence-name">${escapeHtml(seq.name)}</div>
              <div class="sequence-meta">${seq.step_count || 0} steps â€¢ ${seq.trigger_type || 'subscribe'}</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Sequences error:', err);
        container.innerHTML = `<p class="text-danger text-sm p-4">Failed to load</p>`;
      }
    }
    
    async function loadCampaigns() {
      const container = document.getElementById('campaigns-container');
      try {
        const result = await CourierAPI.campaigns();
        const campaigns = result.emails || [];
        
        if (campaigns.length === 0) {
          container.innerHTML = `<div class="empty-state"><p>No campaigns yet</p></div>`;
          return;
        }
        
        container.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-4);">
            ${campaigns.slice(0, 6).map(c => `
              <div class="campaign-item" onclick="location.href='campaigns.html?id=${c.id}'">
                <div class="campaign-icon ${c.status || 'draft'}">
                  ${c.status === 'sent' ? 'âœ…' : c.status === 'scheduled' ? 'ğŸ“…' : 'ğŸ“'}
                </div>
                <div class="campaign-content">
                  <div class="campaign-title">${escapeHtml(c.subject || c.title || 'Untitled')}</div>
                  <div class="campaign-meta">
                    <span class="badge badge-${c.status === 'sent' ? 'success' : 'default'}">${c.status || 'draft'}</span>
                  </div>
                  ${c.status === 'sent' ? `
                    <div class="campaign-stats">
                      <span>ğŸ“¤ ${c.sent_count || 0}</span>
                      <span>ğŸ‘€ ${c.open_count || 0}</span>
                      <span>ğŸ–±ï¸ ${c.click_count || 0}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } catch (err) {
        console.error('Campaigns error:', err);
        container.innerHTML = `<p class="text-danger text-sm p-4">Failed to load</p>`;
      }
    }
    
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
