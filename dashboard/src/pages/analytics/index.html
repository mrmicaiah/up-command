<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - UP Command</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .analytics-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .analytics-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--font-semibold);
    }
    
    .header-controls {
      display: flex;
      gap: var(--space-3);
      align-items: center;
    }
    
    .property-select {
      padding: var(--space-2) var(--space-4);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: var(--text-sm);
      min-width: 200px;
    }
    
    .date-range {
      display: flex;
      gap: var(--space-1);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-1);
    }
    
    .date-btn {
      padding: var(--space-2) var(--space-3);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .date-btn:hover {
      color: var(--text-primary);
    }
    
    .date-btn.active {
      background: var(--accent);
      color: var(--text-inverse);
    }
    
    /* Real-time Panel */
    .realtime-panel {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      display: flex;
      gap: var(--space-8);
      align-items: center;
    }
    
    .realtime-main {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    .realtime-pulse {
      width: 16px;
      height: 16px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .realtime-count {
      font-family: var(--font-display);
      font-size: var(--text-4xl);
      font-weight: var(--font-bold);
      color: var(--success);
    }
    
    .realtime-label {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }
    
    .realtime-pages {
      flex: 1;
      min-width: 0;
    }
    
    .realtime-pages-title {
      font-size: var(--text-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-2);
    }
    
    .realtime-page {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      padding: var(--space-1) 0;
    }
    
    .realtime-page-count {
      font-weight: var(--font-medium);
      color: var(--text-primary);
      min-width: 24px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
    }
    
    .stat-label {
      font-size: var(--text-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-2);
    }
    
    .stat-value {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      margin-bottom: var(--space-1);
    }
    
    .stat-change {
      font-size: var(--text-xs);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .stat-change.up {
      color: var(--success);
    }
    
    .stat-change.down {
      color: var(--danger);
    }
    
    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--space-6);
      margin-bottom: var(--space-6);
    }
    
    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
    }
    
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }
    
    .chart-title {
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    .chart-container.small {
      height: 250px;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
    }
    
    .data-table th {
      text-align: left;
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--border);
    }
    
    .data-table td {
      padding: var(--space-3);
      border-bottom: 1px solid var(--border);
      font-size: var(--text-sm);
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table tr:hover {
      background: var(--bg-hover);
    }
    
    .page-path {
      color: var(--text-primary);
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .bar-cell {
      width: 100px;
    }
    
    .mini-bar {
      height: 8px;
      background: var(--bg-hover);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .mini-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: var(--radius-full);
    }
    
    /* Bottom Grid */
    .bottom-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: var(--space-6);
    }
    
    /* No Data State */
    .no-data {
      text-align: center;
      padding: var(--space-8);
      color: var(--text-muted);
    }
    
    .no-data-icon {
      font-size: 3rem;
      margin-bottom: var(--space-4);
    }
    
    /* Loading */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-8);
      color: var(--text-muted);
    }
    
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(10, 14, 20, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-xl);
    }
    
    /* Connection Status */
    .connection-banner {
      background: var(--warning-muted);
      border: 1px solid var(--warning);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .connection-text {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--warning);
    }
  </style>
</head>
<body>
  <script src="../../shared/api.js"></script>
  <script src="../../shared/auth.js"></script>
  <script src="../../shared/nav.js"></script>
  
  <script>
    let properties = [];
    let selectedProperty = null;
    let dateRange = 7;
    let trafficChart = null;
    let sourcesChart = null;
    let isConnected = false;
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = requireAuth();
      if (!user) return;
      
      const main = initLayout('analytics', { showThread: false });
      main.innerHTML = renderPage();
      
      await checkConnection();
      if (isConnected) {
        await loadProperties();
      }
    });
    
    function renderPage() {
      return `
        <div class="analytics-header">
          <h1 class="analytics-title">ğŸ“Š Analytics</h1>
          <div class="header-controls">
            <select class="property-select" id="property-select" onchange="onPropertyChange()">
              <option value="">Select property...</option>
            </select>
            <div class="date-range">
              <button class="date-btn active" data-days="7" onclick="setDateRange(7)">7D</button>
              <button class="date-btn" data-days="14" onclick="setDateRange(14)">14D</button>
              <button class="date-btn" data-days="30" onclick="setDateRange(30)">30D</button>
              <button class="date-btn" data-days="90" onclick="setDateRange(90)">90D</button>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="refreshData()">ğŸ”„ Refresh</button>
          </div>
        </div>
        
        <div id="connection-banner"></div>
        
        <!-- Real-time Panel -->
        <div class="realtime-panel" id="realtime-panel">
          <div class="realtime-main">
            <div class="realtime-pulse"></div>
            <div>
              <div class="realtime-count" id="realtime-count">-</div>
              <div class="realtime-label">Active users now</div>
            </div>
          </div>
          <div class="realtime-pages">
            <div class="realtime-pages-title">Currently viewing</div>
            <div id="realtime-pages">
              <span class="text-muted text-sm">Loading...</span>
            </div>
          </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Users</div>
            <div class="stat-value" id="stat-users">-</div>
            <div class="stat-change" id="stat-users-change"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Page Views</div>
            <div class="stat-value" id="stat-pageviews">-</div>
            <div class="stat-change" id="stat-pageviews-change"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Sessions</div>
            <div class="stat-value" id="stat-sessions">-</div>
            <div class="stat-change" id="stat-sessions-change"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg. Duration</div>
            <div class="stat-value" id="stat-duration">-</div>
            <div class="stat-change" id="stat-duration-change"></div>
          </div>
        </div>
        
        <!-- Charts Row -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">ğŸ“ˆ Traffic Over Time</h3>
            </div>
            <div class="chart-container">
              <canvas id="traffic-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">ğŸ”— Traffic Sources</h3>
            </div>
            <div class="chart-container small">
              <canvas id="sources-chart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Bottom Grid -->
        <div class="bottom-grid">
          <!-- Top Pages -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">ğŸ“„ Top Pages</h3>
            </div>
            <div id="top-pages">
              <div class="loading-state">
                <div class="spinner spinner-sm"></div>
                <span>Loading...</span>
              </div>
            </div>
          </div>
          
          <!-- Geography -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">ğŸŒ Top Countries</h3>
            </div>
            <div id="geography">
              <div class="loading-state">
                <div class="spinner spinner-sm"></div>
                <span>Loading...</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    async function checkConnection() {
      try {
        const status = await Integrations.status();
        isConnected = status?.services?.google_analytics || status?.services?.gmail_company;
        
        if (!isConnected) {
          document.getElementById('connection-banner').innerHTML = `
            <div class="connection-banner">
              <div class="connection-text">
                âš ï¸ Google Analytics not connected
              </div>
              <button class="btn btn-primary btn-sm" onclick="connectAnalytics()">Connect GA4</button>
            </div>
          `;
        }
      } catch (err) {
        console.error('Failed to check connection:', err);
        isConnected = true; // Assume connected and try anyway
      }
    }
    
    async function connectAnalytics() {
      try {
        const result = await Integrations.connect('google_analytics');
        if (result?.url) {
          window.open(result.url, '_blank');
        }
      } catch (err) {
        alert('Failed to initiate connection');
      }
    }
    
    async function loadProperties() {
      try {
        const result = await Analytics.properties();
        properties = result?.properties || [];
        
        const select = document.getElementById('property-select');
        select.innerHTML = '<option value="">Select property...</option>' +
          properties.map(p => `<option value="${p.property_id}">${escapeHtml(p.name)}</option>`).join('');
        
        if (properties.length > 0) {
          select.value = properties[0].property_id;
          selectedProperty = properties[0].property_id;
          await loadAllData();
        } else {
          showNoProperties();
        }
      } catch (err) {
        console.error('Failed to load properties:', err);
        showError('Failed to load GA4 properties. Make sure Google Analytics is connected.');
      }
    }
    
    function showNoProperties() {
      document.getElementById('realtime-panel').innerHTML = `
        <div class="no-data" style="width: 100%;">
          <div class="no-data-icon">ğŸ“Š</div>
          <p>No GA4 properties configured</p>
          <p class="text-sm mt-2">Connect a GA4 property to see analytics data.</p>
        </div>
      `;
    }
    
    function showError(message) {
      document.getElementById('connection-banner').innerHTML = `
        <div class="connection-banner" style="background: var(--danger-muted); border-color: var(--danger);">
          <div class="connection-text" style="color: var(--danger);">
            âŒ ${message}
          </div>
        </div>
      `;
    }
    
    async function onPropertyChange() {
      const select = document.getElementById('property-select');
      selectedProperty = select.value;
      if (selectedProperty) {
        await loadAllData();
      }
    }
    
    function setDateRange(days) {
      dateRange = days;
      document.querySelectorAll('.date-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.days == days);
      });
      if (selectedProperty) {
        loadAllData();
      }
    }
    
    async function refreshData() {
      if (selectedProperty) {
        await loadAllData();
      }
    }
    
    async function loadAllData() {
      if (!selectedProperty) return;
      
      await Promise.all([
        loadRealtime(),
        loadReport(),
        loadTopContent(),
        loadSources(),
        loadGeography()
      ]);
    }
    
    async function loadRealtime() {
      try {
        const data = await Analytics.realtime(selectedProperty);
        
        document.getElementById('realtime-count').textContent = data?.activeUsers || 0;
        
        const pages = data?.topPages || [];
        const pagesHtml = pages.length > 0 
          ? pages.slice(0, 5).map(p => `
              <div class="realtime-page">
                <span class="realtime-page-count">${p.activeUsers}</span>
                <span class="page-path">${escapeHtml(p.pagePath || p.pageTitle)}</span>
              </div>
            `).join('')
          : '<span class="text-muted text-sm">No active pages</span>';
        
        document.getElementById('realtime-pages').innerHTML = pagesHtml;
      } catch (err) {
        console.error('Realtime error:', err);
        document.getElementById('realtime-count').textContent = '-';
        document.getElementById('realtime-pages').innerHTML = '<span class="text-muted text-sm">Unable to load</span>';
      }
    }
    
    async function loadReport() {
      try {
        const data = await Analytics.report(selectedProperty, dateRange);
        
        // Update stats
        document.getElementById('stat-users').textContent = formatNumber(data?.users || 0);
        document.getElementById('stat-pageviews').textContent = formatNumber(data?.pageViews || 0);
        document.getElementById('stat-sessions').textContent = formatNumber(data?.sessions || 0);
        document.getElementById('stat-duration').textContent = formatDuration(data?.avgSessionDuration || 0);
        
        // Update change indicators
        updateChange('stat-users-change', data?.usersChange);
        updateChange('stat-pageviews-change', data?.pageViewsChange);
        updateChange('stat-sessions-change', data?.sessionsChange);
        updateChange('stat-duration-change', data?.durationChange);
        
        // Update traffic chart
        const dailyData = data?.daily || [];
        updateTrafficChart(dailyData);
      } catch (err) {
        console.error('Report error:', err);
        document.getElementById('stat-users').textContent = '-';
        document.getElementById('stat-pageviews').textContent = '-';
        document.getElementById('stat-sessions').textContent = '-';
        document.getElementById('stat-duration').textContent = '-';
      }
    }
    
    function updateChange(elementId, value) {
      const el = document.getElementById(elementId);
      if (!el) return;
      
      if (value === undefined || value === null) {
        el.innerHTML = '';
        return;
      }
      
      const isUp = value >= 0;
      el.className = `stat-change ${isUp ? 'up' : 'down'}`;
      el.innerHTML = `${isUp ? 'â†‘' : 'â†“'} ${Math.abs(value).toFixed(1)}%`;
    }
    
    function updateTrafficChart(dailyData) {
      const ctx = document.getElementById('traffic-chart').getContext('2d');
      
      if (trafficChart) {
        trafficChart.destroy();
      }
      
      const labels = dailyData.map(d => formatChartDate(d.date));
      const users = dailyData.map(d => d.users || 0);
      const pageViews = dailyData.map(d => d.pageViews || 0);
      
      trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Users',
              data: users,
              borderColor: '#e5a84b',
              backgroundColor: 'rgba(229, 168, 75, 0.1)',
              fill: true,
              tension: 0.3
            },
            {
              label: 'Page Views',
              data: pageViews,
              borderColor: '#60a5fa',
              backgroundColor: 'rgba(96, 165, 250, 0.1)',
              fill: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#8b95a5' }
            }
          },
          scales: {
            x: {
              grid: { color: '#2a3441' },
              ticks: { color: '#8b95a5' }
            },
            y: {
              grid: { color: '#2a3441' },
              ticks: { color: '#8b95a5' }
            }
          }
        }
      });
    }
    
    async function loadSources() {
      try {
        const data = await Analytics.sources(selectedProperty, dateRange);
        const sources = data?.sources || [];
        
        updateSourcesChart(sources);
      } catch (err) {
        console.error('Sources error:', err);
      }
    }
    
    function updateSourcesChart(sources) {
      const ctx = document.getElementById('sources-chart').getContext('2d');
      
      if (sourcesChart) {
        sourcesChart.destroy();
      }
      
      const colors = ['#e5a84b', '#60a5fa', '#4ade80', '#fb923c', '#f87171', '#a78bfa'];
      
      sourcesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sources.map(s => s.source || 'Direct'),
          datasets: [{
            data: sources.map(s => s.sessions || s.users || 0),
            backgroundColor: colors.slice(0, sources.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#8b95a5', padding: 10 }
            }
          }
        }
      });
    }
    
    async function loadTopContent() {
      const container = document.getElementById('top-pages');
      try {
        const data = await Analytics.topContent(selectedProperty, dateRange, 10);
        const pages = data?.pages || [];
        
        if (pages.length === 0) {
          container.innerHTML = '<div class="no-data"><p>No page data available</p></div>';
          return;
        }
        
        const maxViews = Math.max(...pages.map(p => p.pageViews || 0));
        
        container.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Page</th>
                <th>Views</th>
                <th class="bar-cell"></th>
              </tr>
            </thead>
            <tbody>
              ${pages.map(page => `
                <tr>
                  <td><span class="page-path" title="${escapeHtml(page.pagePath)}">${escapeHtml(page.pageTitle || page.pagePath)}</span></td>
                  <td>${formatNumber(page.pageViews || 0)}</td>
                  <td class="bar-cell">
                    <div class="mini-bar">
                      <div class="mini-bar-fill" style="width: ${((page.pageViews || 0) / maxViews * 100).toFixed(1)}%"></div>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Top content error:', err);
        container.innerHTML = '<div class="no-data"><p>Failed to load top pages</p></div>';
      }
    }
    
    async function loadGeography() {
      const container = document.getElementById('geography');
      try {
        const data = await Analytics.geography(selectedProperty, dateRange);
        const countries = data?.countries || [];
        
        if (countries.length === 0) {
          container.innerHTML = '<div class="no-data"><p>No geographic data available</p></div>';
          return;
        }
        
        const maxUsers = Math.max(...countries.map(c => c.users || 0));
        
        container.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Country</th>
                <th>Users</th>
                <th class="bar-cell"></th>
              </tr>
            </thead>
            <tbody>
              ${countries.slice(0, 10).map(country => `
                <tr>
                  <td>${getCountryFlag(country.country)} ${escapeHtml(country.country)}</td>
                  <td>${formatNumber(country.users || 0)}</td>
                  <td class="bar-cell">
                    <div class="mini-bar">
                      <div class="mini-bar-fill" style="width: ${((country.users || 0) / maxUsers * 100).toFixed(1)}%"></div>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Geography error:', err);
        container.innerHTML = '<div class="no-data"><p>Failed to load geography data</p></div>';
      }
    }
    
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toLocaleString();
    }
    
    function formatDuration(seconds) {
      if (!seconds) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function formatChartDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    function getCountryFlag(country) {
      const flags = {
        'United States': 'ğŸ‡ºğŸ‡¸',
        'United Kingdom': 'ğŸ‡¬ğŸ‡§',
        'Canada': 'ğŸ‡¨ğŸ‡¦',
        'Australia': 'ğŸ‡¦ğŸ‡º',
        'Germany': 'ğŸ‡©ğŸ‡ª',
        'France': 'ğŸ‡«ğŸ‡·',
        'India': 'ğŸ‡®ğŸ‡³',
        'Brazil': 'ğŸ‡§ğŸ‡·',
        'Japan': 'ğŸ‡¯ğŸ‡µ',
        'Mexico': 'ğŸ‡²ğŸ‡½',
        'Spain': 'ğŸ‡ªğŸ‡¸',
        'Italy': 'ğŸ‡®ğŸ‡¹',
        'Netherlands': 'ğŸ‡³ğŸ‡±',
        'South Korea': 'ğŸ‡°ğŸ‡·',
        'Russia': 'ğŸ‡·ğŸ‡º',
        'China': 'ğŸ‡¨ğŸ‡³'
      };
      return flags[country] || 'ğŸŒ';
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>