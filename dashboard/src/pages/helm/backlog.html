<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backlog - Helm - UP Command</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <link rel="stylesheet" href="helm.css">
  <style>
    .backlog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .backlog-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--font-semibold);
    }
    
    .backlog-stats {
      display: flex;
      gap: var(--space-4);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }
    
    .backlog-stat {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .backlog-stat strong {
      color: var(--text-primary);
    }
    
    .filter-bar {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: var(--space-2) var(--space-3);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-sm);
    }
    
    .filter-checkbox {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .filter-checkbox input {
      accent-color: var(--accent);
    }
    
    .priority-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .priority-1 { background: var(--danger); }
    .priority-2 { background: var(--warning); }
    .priority-3 { background: var(--text-muted); }
    .priority-4 { background: var(--info); opacity: 0.6; }
    .priority-5 { background: var(--text-muted); opacity: 0.3; }
    
    .task-tag {
      padding: 1px var(--space-2);
      border-radius: var(--radius-sm);
      background: var(--bg-hover);
      color: var(--text-muted);
      font-size: var(--text-xs);
    }
    
    .task-tag.project {
      background: var(--accent-muted);
      color: var(--accent);
    }
    
    .task-tag.due {
      background: var(--warning-muted);
      color: var(--warning);
    }
    
    .task-tag.due.overdue {
      background: var(--danger-muted);
      color: var(--danger);
    }
    
    .task-tag.active {
      background: var(--success-muted);
      color: var(--success);
    }
    
    /* Category Sections */
    .category-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-4);
      overflow: hidden;
    }
    
    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      background: var(--bg-secondary);
      cursor: pointer;
      user-select: none;
    }
    
    .category-header:hover {
      background: var(--bg-hover);
    }
    
    .category-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-weight: var(--font-semibold);
    }
    
    .category-count {
      font-size: var(--text-xs);
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 2px var(--space-2);
      border-radius: var(--radius-full);
    }
    
    .category-arrow {
      transition: transform var(--transition-fast);
    }
    
    .category-section.collapsed .category-arrow {
      transform: rotate(-90deg);
    }
    
    .category-section.collapsed .category-tasks {
      display: none;
    }
    
    .category-tasks {
      padding: var(--space-2);
    }
    
    .list-task {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      transition: background var(--transition-fast);
    }
    
    .list-task:hover {
      background: var(--bg-hover);
    }
    
    .task-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }
    
    .task-checkbox:hover {
      border-color: var(--success);
      background: var(--success-muted);
    }
    
    .list-task-content {
      flex: 1;
      min-width: 0;
    }
    
    .list-task-text {
      font-size: var(--text-sm);
      margin-bottom: var(--space-1);
    }
    
    .list-task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    
    .list-task-actions {
      display: flex;
      gap: var(--space-1);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    
    .list-task:hover .list-task-actions {
      opacity: 1;
    }
    
    .action-btn {
      padding: var(--space-1) var(--space-2);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
    }
    
    .action-btn:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }
    
    .empty-column {
      text-align: center;
      padding: var(--space-6);
      color: var(--text-muted);
      font-size: var(--text-sm);
    }
    
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-8);
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <script src="../../shared/api.js"></script>
  <script src="../../shared/auth.js"></script>
  <script src="../../shared/nav.js"></script>
  
  <script>
    let allTasks = [];
    let filteredTasks = [];
    let categories = [];
    let filters = {
      priority: '',
      hasDueDate: false,
      project: ''
    };
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = requireAuth();
      if (!user) return;
      
      const main = initLayout('helm', { showThread: false });
      main.innerHTML = renderPage();
      
      await loadTasks();
      setupEventListeners();
    });
    
    function renderPage() {
      return `
        <header class="helm-header">
          <h1 class="helm-title">âš“ Helm</h1>
          <p class="helm-subtitle">Task management & sprint planning</p>
          <nav class="helm-nav">
            <a href="index.html" class="helm-nav-item">Overview</a>
            <a href="tasks.html" class="helm-nav-item">Tasks</a>
            <a href="sprint.html" class="helm-nav-item">Sprint</a>
            <a href="backlog.html" class="helm-nav-item active">Backlog</a>
            <a href="routines.html" class="helm-nav-item">Routines</a>
          </nav>
        </header>
        
        <div class="backlog-header">
          <div>
            <h2 class="backlog-title">ğŸ“š Backlog</h2>
            <div class="backlog-stats">
              <div class="backlog-stat"><strong id="total-count">0</strong> tasks</div>
              <div class="backlog-stat"><strong id="category-count">0</strong> categories</div>
            </div>
          </div>
        </div>
        
        <div class="filter-bar">
          <select class="filter-select" id="priority-filter">
            <option value="">All Priorities</option>
            <option value="1">ğŸ”´ P1 - Urgent</option>
            <option value="2">ğŸŸ  P2 - High</option>
            <option value="3">âšª P3 - Normal</option>
            <option value="4">ğŸ”µ P4 - Low</option>
            <option value="5">âš« P5 - Someday</option>
          </select>
          <select class="filter-select" id="project-filter">
            <option value="">All Projects</option>
          </select>
          <label class="filter-checkbox">
            <input type="checkbox" id="due-filter">
            <span>Has due date</span>
          </label>
        </div>
        
        <div id="list-container">
          <div class="loading-state">
            <div class="spinner"></div>
            <span>Loading backlog...</span>
          </div>
        </div>
      `;
    }
    
    function setupEventListeners() {
      document.getElementById('priority-filter').addEventListener('change', (e) => {
        filters.priority = e.target.value;
        applyFilters();
      });
      
      document.getElementById('project-filter').addEventListener('change', (e) => {
        filters.project = e.target.value;
        applyFilters();
      });
      
      document.getElementById('due-filter').addEventListener('change', (e) => {
        filters.hasDueDate = e.target.checked;
        applyFilters();
      });
    }
    
    async function loadTasks() {
      try {
        const res = await Tasks.list({ status: 'open', is_recurring: false, limit: 500 });
        allTasks = res.tasks || [];
        
        // Extract categories and projects
        categories = [...new Set(allTasks.map(t => t.category || 'Uncategorized'))].sort((a, b) => {
          if (a === 'Uncategorized') return 1;
          if (b === 'Uncategorized') return -1;
          return a.localeCompare(b);
        });
        
        const projects = [...new Set(allTasks.map(t => t.project).filter(Boolean))].sort();
        
        // Populate project filter
        const projectSelect = document.getElementById('project-filter');
        projectSelect.innerHTML = '<option value="">All Projects</option>' +
          projects.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
        
        applyFilters();
      } catch (err) {
        console.error('Failed to load tasks:', err);
        document.getElementById('list-container').innerHTML = `
          <div class="empty-column">
            <p>âŒ Failed to load tasks</p>
            <button class="btn btn-secondary btn-sm mt-4" onclick="loadTasks()">Retry</button>
          </div>
        `;
      }
    }
    
    function applyFilters() {
      filteredTasks = allTasks.filter(task => {
        if (filters.priority && task.priority != filters.priority) return false;
        if (filters.hasDueDate && !task.due_date) return false;
        if (filters.project && task.project !== filters.project) return false;
        return true;
      });
      
      // Recalculate categories based on filtered tasks
      const filteredCategories = [...new Set(filteredTasks.map(t => t.category || 'Uncategorized'))].sort((a, b) => {
        if (a === 'Uncategorized') return 1;
        if (b === 'Uncategorized') return -1;
        return a.localeCompare(b);
      });
      
      // Update stats
      document.getElementById('total-count').textContent = filteredTasks.length;
      document.getElementById('category-count').textContent = filteredCategories.length;
      
      renderList(filteredCategories);
    }
    
    function renderList(categoriesToShow) {
      const container = document.getElementById('list-container');
      
      if (filteredTasks.length === 0) {
        container.innerHTML = `
          <div class="empty-column">
            <p>ğŸ‰ No tasks in backlog</p>
          </div>
        `;
        return;
      }
      
      // Group tasks by category
      const tasksByCategory = {};
      categoriesToShow.forEach(cat => tasksByCategory[cat] = []);
      
      filteredTasks.forEach(task => {
        const cat = task.category || 'Uncategorized';
        if (!tasksByCategory[cat]) tasksByCategory[cat] = [];
        tasksByCategory[cat].push(task);
      });
      
      // Sort tasks within each category by priority
      Object.keys(tasksByCategory).forEach(cat => {
        tasksByCategory[cat].sort((a, b) => (a.priority || 3) - (b.priority || 3));
      });
      
      container.innerHTML = categoriesToShow.map(category => {
        const tasks = tasksByCategory[category] || [];
        if (tasks.length === 0) return '';
        
        return `
          <div class="category-section" data-category="${escapeHtml(category)}">
            <div class="category-header" onclick="toggleCategory(this)">
              <div class="category-title">
                <span class="category-arrow">â–¼</span>
                ${getCategoryIcon(category)} ${escapeHtml(category)}
                <span class="category-count">${tasks.length}</span>
              </div>
            </div>
            <div class="category-tasks">
              ${tasks.map(task => renderListTask(task)).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderListTask(task) {
      const isOverdue = task.due_date && new Date(task.due_date) < new Date();
      
      return `
        <div class="list-task" data-id="${task.id}">
          <div class="task-checkbox" onclick="event.stopPropagation(); completeTask('${task.id}')" title="Complete"></div>
          <div class="priority-dot priority-${task.priority || 3}"></div>
          <div class="list-task-content">
            <div class="list-task-text">${escapeHtml(task.text)}</div>
            <div class="list-task-meta">
              ${task.project ? `<span class="task-tag project">${escapeHtml(task.project)}</span>` : ''}
              ${task.due_date ? `<span class="task-tag due ${isOverdue ? 'overdue' : ''}">${formatDue(task.due_date)}</span>` : ''}
              ${task.is_active ? `<span class="task-tag active">Active</span>` : ''}
            </div>
          </div>
          <div class="list-task-actions">
            <button class="action-btn" onclick="event.stopPropagation(); activateTask('${task.id}')" title="Add to Active">âš¡</button>
            <button class="action-btn" onclick="event.stopPropagation(); deleteTask('${task.id}')" title="Delete">ğŸ—‘ï¸</button>
          </div>
        </div>
      `;
    }
    
    function toggleCategory(header) {
      header.parentElement.classList.toggle('collapsed');
    }
    
    function getCategoryIcon(category) {
      const icons = {
        'Work': 'ğŸ’¼',
        'Personal': 'ğŸ ',
        'Health': 'ğŸ’ª',
        'Finance': 'ğŸ’°',
        'Learning': 'ğŸ“š',
        'Projects': 'ğŸš€',
        'Errands': 'ğŸƒ',
        'Waiting': 'â³',
        'Blog System': 'ğŸ“',
        'Development': 'ğŸ’»',
        'Freelance': 'ğŸ¯',
        'Uncategorized': 'ğŸ“‹'
      };
      return icons[category] || 'ğŸ“';
    }
    
    function formatDue(dateStr) {
      if (!dateStr) return '';
      const due = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      due.setHours(0, 0, 0, 0);
      
      const diff = Math.floor((due - today) / 86400000);
      
      if (diff < 0) return `${Math.abs(diff)}d overdue`;
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Tomorrow';
      if (diff < 7) return `${diff}d`;
      
      return due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    async function completeTask(id) {
      try {
        await Tasks.complete(id);
        await loadTasks();
      } catch (err) {
        alert('Failed to complete task');
      }
    }
    
    async function activateTask(id) {
      try {
        await Tasks.update(id, { is_active: 1 });
        await loadTasks();
      } catch (err) {
        alert('Failed to activate task');
      }
    }
    
    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        await Tasks.delete(id);
        await loadTasks();
      } catch (err) {
        alert('Failed to delete task');
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
