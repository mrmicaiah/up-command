<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backlog - Helm - UP Command</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <link rel="stylesheet" href="helm.css">
  <style>
    .backlog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .backlog-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--font-semibold);
    }
    
    .backlog-stats {
      display: flex;
      gap: var(--space-4);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }
    
    .backlog-stat strong {
      color: var(--text-primary);
    }
    
    .filter-bar {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: var(--space-2) var(--space-3);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-sm);
    }
    
    .search-input {
      padding: var(--space-2) var(--space-3);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-sm);
      min-width: 200px;
    }
    
    .search-input::placeholder {
      color: var(--text-muted);
    }
    
    .task-list {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      overflow: hidden;
    }
    
    .task-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      border-bottom: 1px solid var(--border);
      transition: background var(--transition-fast);
    }
    
    .task-item:last-child {
      border-bottom: none;
    }
    
    .task-item:hover {
      background: var(--bg-hover);
    }
    
    .task-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }
    
    .task-checkbox:hover {
      border-color: var(--success);
      background: var(--success-muted);
    }
    
    .priority-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .priority-1 { background: var(--danger); }
    .priority-2 { background: var(--warning); }
    .priority-3 { background: var(--text-muted); }
    .priority-4 { background: var(--info); opacity: 0.6; }
    .priority-5 { background: var(--text-muted); opacity: 0.3; }
    
    .task-content {
      flex: 1;
      min-width: 0;
    }
    
    .task-text {
      font-size: var(--text-base);
      margin-bottom: var(--space-1);
    }
    
    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      font-size: var(--text-xs);
      color: var(--text-muted);
    }
    
    .task-tag {
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      background: var(--bg-hover);
    }
    
    .task-tag.category {
      background: var(--accent-muted);
      color: var(--accent);
    }
    
    .task-tag.project {
      background: var(--info-muted);
      color: var(--info);
    }
    
    .task-tag.due {
      background: var(--warning-muted);
      color: var(--warning);
    }
    
    .task-tag.overdue {
      background: var(--danger-muted);
      color: var(--danger);
    }
    
    .task-tag.active {
      background: var(--success-muted);
      color: var(--success);
    }
    
    .task-actions {
      display: flex;
      gap: var(--space-1);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    
    .task-item:hover .task-actions {
      opacity: 1;
    }
    
    .action-btn {
      padding: var(--space-2);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      transition: all var(--transition-fast);
    }
    
    .action-btn:hover {
      background: var(--bg-active);
      color: var(--text-primary);
      border-color: var(--border-light);
    }
    
    .action-btn.primary:hover {
      background: var(--accent-muted);
      color: var(--accent);
      border-color: var(--accent);
    }
    
    .empty-state {
      text-align: center;
      padding: var(--space-12);
      color: var(--text-muted);
    }
    
    .empty-state p {
      margin-bottom: var(--space-4);
    }
    
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-12);
      color: var(--text-muted);
    }
    
    .sort-info {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-bottom: var(--space-3);
    }
  </style>
</head>
<body>
  <script src="../../shared/api.js"></script>
  <script src="../../shared/auth.js"></script>
  <script src="../../shared/nav.js"></script>
  
  <script>
    let allTasks = [];
    let filteredTasks = [];
    let filters = {
      priority: '',
      category: '',
      project: '',
      search: ''
    };
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = requireAuth();
      if (!user) return;
      
      const main = initLayout('helm', { showThread: false });
      main.innerHTML = renderPage();
      
      await loadTasks();
      setupEventListeners();
    });
    
    function renderPage() {
      return `
        <header class="helm-header">
          <h1 class="helm-title">‚öì Helm</h1>
          <p class="helm-subtitle">Task management & sprint planning</p>
          <nav class="helm-nav">
            <a href="index.html" class="helm-nav-item">Overview</a>
            <a href="tasks.html" class="helm-nav-item">Tasks</a>
            <a href="sprint.html" class="helm-nav-item">Sprint</a>
            <a href="backlog.html" class="helm-nav-item active">Backlog</a>
            <a href="routines.html" class="helm-nav-item">Routines</a>
          </nav>
        </header>
        
        <div class="backlog-header">
          <div>
            <h2 class="backlog-title">üìö Backlog</h2>
            <div class="backlog-stats">
              <span><strong id="total-count">0</strong> tasks</span>
            </div>
          </div>
        </div>
        
        <div class="filter-bar">
          <input type="text" class="search-input" id="search-input" placeholder="üîç Search tasks...">
          <select class="filter-select" id="priority-filter">
            <option value="">All Priorities</option>
            <option value="1">üî¥ P1 - Urgent</option>
            <option value="2">üü† P2 - High</option>
            <option value="3">‚ö™ P3 - Normal</option>
            <option value="4">üîµ P4 - Low</option>
            <option value="5">‚ö´ P5 - Someday</option>
          </select>
          <select class="filter-select" id="category-filter">
            <option value="">All Categories</option>
          </select>
          <select class="filter-select" id="project-filter">
            <option value="">All Projects</option>
          </select>
        </div>
        
        <div class="sort-info">Sorted by priority (highest first), then by date created</div>
        
        <div class="task-list" id="task-list">
          <div class="loading-state">
            <div class="spinner"></div>
            <span>Loading backlog...</span>
          </div>
        </div>
      `;
    }
    
    function setupEventListeners() {
      document.getElementById('search-input').addEventListener('input', (e) => {
        filters.search = e.target.value.toLowerCase();
        applyFilters();
      });
      
      document.getElementById('priority-filter').addEventListener('change', (e) => {
        filters.priority = e.target.value;
        applyFilters();
      });
      
      document.getElementById('category-filter').addEventListener('change', (e) => {
        filters.category = e.target.value;
        applyFilters();
      });
      
      document.getElementById('project-filter').addEventListener('change', (e) => {
        filters.project = e.target.value;
        applyFilters();
      });
    }
    
    async function loadTasks() {
      try {
        // Get all open, non-recurring tasks (backlog = not in sprint, not routines)
        const res = await Tasks.list({ status: 'open', is_recurring: false, limit: 500 });
        allTasks = res.tasks || [];
        
        // Extract unique categories and projects for filters
        const categories = [...new Set(allTasks.map(t => t.category).filter(Boolean))].sort();
        const projects = [...new Set(allTasks.map(t => t.project).filter(Boolean))].sort();
        
        // Populate filter dropdowns
        document.getElementById('category-filter').innerHTML = 
          '<option value="">All Categories</option>' +
          categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        
        document.getElementById('project-filter').innerHTML = 
          '<option value="">All Projects</option>' +
          projects.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
        
        applyFilters();
      } catch (err) {
        console.error('Failed to load tasks:', err);
        document.getElementById('task-list').innerHTML = `
          <div class="empty-state">
            <p>‚ùå Failed to load tasks</p>
            <button class="btn btn-secondary" onclick="loadTasks()">Retry</button>
          </div>
        `;
      }
    }
    
    function applyFilters() {
      filteredTasks = allTasks.filter(task => {
        if (filters.priority && task.priority != filters.priority) return false;
        if (filters.category && task.category !== filters.category) return false;
        if (filters.project && task.project !== filters.project) return false;
        if (filters.search && !task.text.toLowerCase().includes(filters.search)) return false;
        return true;
      });
      
      // Sort by priority (1 is highest), then by created_at
      filteredTasks.sort((a, b) => {
        const pA = a.priority || 3;
        const pB = b.priority || 3;
        if (pA !== pB) return pA - pB;
        return new Date(b.created_at) - new Date(a.created_at);
      });
      
      document.getElementById('total-count').textContent = filteredTasks.length;
      renderTaskList();
    }
    
    function renderTaskList() {
      const container = document.getElementById('task-list');
      
      if (filteredTasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>üéâ No tasks in backlog${filters.search || filters.priority || filters.category || filters.project ? ' matching filters' : ''}</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredTasks.map(task => {
        const isOverdue = task.due_date && new Date(task.due_date) < new Date();
        
        return `
          <div class="task-item" data-id="${task.id}">
            <div class="task-checkbox" onclick="completeTask('${task.id}')" title="Complete"></div>
            <div class="priority-dot priority-${task.priority || 3}" title="Priority ${task.priority || 3}"></div>
            <div class="task-content">
              <div class="task-text">${escapeHtml(task.text)}</div>
              <div class="task-meta">
                ${task.category ? `<span class="task-tag category">${escapeHtml(task.category)}</span>` : ''}
                ${task.project ? `<span class="task-tag project">${escapeHtml(task.project)}</span>` : ''}
                ${task.due_date ? `<span class="task-tag ${isOverdue ? 'overdue' : 'due'}">${formatDue(task.due_date)}</span>` : ''}
                ${task.is_active ? `<span class="task-tag active">Active</span>` : ''}
              </div>
            </div>
            <div class="task-actions">
              ${!task.is_active ? `<button class="action-btn primary" onclick="activateTask('${task.id}')" title="Add to Active">‚ö° Active</button>` : ''}
              <button class="action-btn" onclick="deleteTask('${task.id}')" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function formatDue(dateStr) {
      if (!dateStr) return '';
      const due = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      due.setHours(0, 0, 0, 0);
      
      const diff = Math.floor((due - today) / 86400000);
      
      if (diff < 0) return `${Math.abs(diff)}d overdue`;
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Tomorrow';
      if (diff < 7) return `${diff}d`;
      
      return due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    async function completeTask(id) {
      try {
        await Tasks.complete(id);
        await loadTasks();
      } catch (err) {
        alert('Failed to complete task');
      }
    }
    
    async function activateTask(id) {
      try {
        await Tasks.update(id, { is_active: 1 });
        await loadTasks();
      } catch (err) {
        alert('Failed to activate task');
      }
    }
    
    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        await Tasks.delete(id);
        await loadTasks();
      } catch (err) {
        alert('Failed to delete task');
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
