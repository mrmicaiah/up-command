<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backlog - Helm - UP Command</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <link rel="stylesheet" href="helm.css">
  <style>
    .backlog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .backlog-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--font-semibold);
    }
    
    .backlog-stats {
      display: flex;
      gap: var(--space-4);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }
    
    .backlog-stat {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .backlog-stat strong {
      color: var(--text-primary);
    }
    
    .view-toggle {
      display: flex;
      gap: var(--space-1);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-1);
    }
    
    .view-btn {
      padding: var(--space-2) var(--space-3);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .view-btn:hover {
      color: var(--text-primary);
    }
    
    .view-btn.active {
      background: var(--accent);
      color: var(--text-inverse);
    }
    
    .filter-bar {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: var(--space-2) var(--space-3);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-sm);
    }
    
    .filter-checkbox {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .filter-checkbox input {
      accent-color: var(--accent);
    }
    
    /* Kanban View */
    .kanban-container {
      display: flex;
      gap: var(--space-4);
      overflow-x: auto;
      padding-bottom: var(--space-4);
    }
    
    .kanban-column {
      flex: 0 0 320px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 300px);
    }
    
    .kanban-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg-card);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }
    
    .kanban-title {
      font-weight: var(--font-semibold);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .kanban-count {
      font-size: var(--text-xs);
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 2px var(--space-2);
      border-radius: var(--radius-full);
    }
    
    .kanban-tasks {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-3);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .kanban-task {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .kanban-task:hover {
      border-color: var(--border-light);
      transform: translateY(-1px);
    }
    
    .kanban-task-header {
      display: flex;
      align-items: flex-start;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }
    
    .priority-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 6px;
    }
    
    .priority-1 { background: var(--danger); }
    .priority-2 { background: var(--warning); }
    .priority-3 { background: var(--text-muted); }
    .priority-4 { background: var(--info); opacity: 0.6; }
    .priority-5 { background: var(--text-muted); opacity: 0.3; }
    
    .kanban-task-text {
      font-size: var(--text-sm);
      line-height: 1.4;
      flex: 1;
    }
    
    .kanban-task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      font-size: var(--text-xs);
    }
    
    .task-tag {
      padding: 1px var(--space-2);
      border-radius: var(--radius-sm);
      background: var(--bg-hover);
      color: var(--text-muted);
    }
    
    .task-tag.project {
      background: var(--accent-muted);
      color: var(--accent);
    }
    
    .task-tag.due {
      background: var(--warning-muted);
      color: var(--warning);
    }
    
    .task-tag.due.overdue {
      background: var(--danger-muted);
      color: var(--danger);
    }
    
    .task-tag.active {
      background: var(--success-muted);
      color: var(--success);
    }
    
    /* List View */
    .list-container {
      display: none;
    }
    
    .list-container.active {
      display: block;
    }
    
    .kanban-container.active {
      display: flex;
    }
    
    .kanban-container:not(.active) {
      display: none;
    }
    
    .category-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-4);
      overflow: hidden;
    }
    
    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      background: var(--bg-secondary);
      cursor: pointer;
      user-select: none;
    }
    
    .category-header:hover {
      background: var(--bg-hover);
    }
    
    .category-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-weight: var(--font-semibold);
    }
    
    .category-arrow {
      transition: transform var(--transition-fast);
    }
    
    .category-section.collapsed .category-arrow {
      transform: rotate(-90deg);
    }
    
    .category-section.collapsed .category-tasks {
      display: none;
    }
    
    .category-tasks {
      padding: var(--space-2);
    }
    
    .list-task {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      transition: background var(--transition-fast);
      cursor: pointer;
    }
    
    .list-task:hover {
      background: var(--bg-hover);
    }
    
    .task-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }
    
    .task-checkbox:hover {
      border-color: var(--accent);
      background: var(--accent-muted);
    }
    
    .list-task-content {
      flex: 1;
      min-width: 0;
    }
    
    .list-task-text {
      font-size: var(--text-sm);
      margin-bottom: var(--space-1);
    }
    
    .list-task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    
    .list-task-actions {
      display: flex;
      gap: var(--space-1);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    
    .list-task:hover .list-task-actions {
      opacity: 1;
    }
    
    .action-btn {
      padding: var(--space-1);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
    }
    
    .action-btn:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }
    
    /* Empty state */
    .empty-column {
      text-align: center;
      padding: var(--space-6);
      color: var(--text-muted);
      font-size: var(--text-sm);
    }
    
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-8);
      color: var(--text-muted);
    }
    
    /* Category assignment dropdown */
    .category-dropdown {
      position: absolute;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 100;
      min-width: 150px;
      display: none;
    }
    
    .category-dropdown.visible {
      display: block;
    }
    
    .category-option {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      cursor: pointer;
    }
    
    .category-option:hover {
      background: var(--bg-hover);
    }
    
    @media (max-width: 768px) {
      .kanban-column {
        flex: 0 0 280px;
      }
      
      .view-toggle {
        display: none;
      }
      
      .kanban-container {
        display: none !important;
      }
      
      .list-container {
        display: block !important;
      }
    }
  </style>
</head>
<body>
  <script src="../../shared/api.js"></script>
  <script src="../../shared/auth.js"></script>
  <script src="../../shared/nav.js"></script>
  
  <script>
    let allTasks = [];
    let filteredTasks = [];
    let categories = [];
    let currentView = 'kanban';
    let filters = {
      priority: '',
      hasDueDate: false,
      project: ''
    };
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = requireAuth();
      if (!user) return;
      
      const main = initLayout('helm', { showThread: false });
      main.innerHTML = renderPage();
      
      await loadTasks();
      setupEventListeners();
    });
    
    function renderPage() {
      return `
        <header class="helm-header">
          <h1 class="helm-title">‚öì Helm</h1>
          <p class="helm-subtitle">Task management & sprint planning</p>
          <nav class="helm-nav">
            <a href="index.html" class="helm-nav-item">Overview</a>
            <a href="tasks.html" class="helm-nav-item">Tasks</a>
            <a href="sprint.html" class="helm-nav-item">Sprint</a>
            <a href="backlog.html" class="helm-nav-item active">Backlog</a>
            <a href="routines.html" class="helm-nav-item">Routines</a>
          </nav>
        </header>
        
        <div class="backlog-header">
          <div>
            <h2 class="backlog-title">üìö Backlog</h2>
            <div class="backlog-stats">
              <div class="backlog-stat"><strong id="total-count">0</strong> tasks</div>
              <div class="backlog-stat"><strong id="category-count">0</strong> categories</div>
            </div>
          </div>
          <div class="view-toggle">
            <button class="view-btn active" data-view="kanban" onclick="setView('kanban')">‚ñ¶ Kanban</button>
            <button class="view-btn" data-view="list" onclick="setView('list')">‚ò∞ List</button>
          </div>
        </div>
        
        <div class="filter-bar">
          <select class="filter-select" id="priority-filter">
            <option value="">All Priorities</option>
            <option value="1">üî¥ P1 - Urgent</option>
            <option value="2">üü† P2 - High</option>
            <option value="3">‚ö™ P3 - Normal</option>
            <option value="4">üîµ P4 - Low</option>
            <option value="5">‚ö´ P5 - Someday</option>
          </select>
          <select class="filter-select" id="project-filter">
            <option value="">All Projects</option>
          </select>
          <label class="filter-checkbox">
            <input type="checkbox" id="due-filter">
            <span>Has due date</span>
          </label>
        </div>
        
        <div class="kanban-container active" id="kanban-view">
          <div class="loading-state">
            <div class="spinner"></div>
            <span>Loading backlog...</span>
          </div>
        </div>
        
        <div class="list-container" id="list-view"></div>
      `;
    }
    
    function setupEventListeners() {
      document.getElementById('priority-filter').addEventListener('change', (e) => {
        filters.priority = e.target.value;
        applyFilters();
      });
      
      document.getElementById('project-filter').addEventListener('change', (e) => {
        filters.project = e.target.value;
        applyFilters();
      });
      
      document.getElementById('due-filter').addEventListener('change', (e) => {
        filters.hasDueDate = e.target.checked;
        applyFilters();
      });
    }
    
    async function loadTasks() {
      try {
        const res = await Tasks.list({ status: 'open', limit: 500 });
        allTasks = res.tasks || [];
        
        // Extract categories and projects
        categories = [...new Set(allTasks.map(t => t.category || 'Uncategorized'))].sort((a, b) => {
          if (a === 'Uncategorized') return 1;
          if (b === 'Uncategorized') return -1;
          return a.localeCompare(b);
        });
        
        const projects = [...new Set(allTasks.map(t => t.project).filter(Boolean))].sort();
        
        // Populate project filter
        const projectSelect = document.getElementById('project-filter');
        projectSelect.innerHTML = '<option value="">All Projects</option>' +
          projects.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
        
        applyFilters();
      } catch (err) {
        console.error('Failed to load tasks:', err);
        document.getElementById('kanban-view').innerHTML = `
          <div class="empty-column" style="grid-column: 1/-1;">
            <p>‚ùå Failed to load tasks</p>
            <button class="btn btn-secondary btn-sm mt-4" onclick="loadTasks()">Retry</button>
          </div>
        `;
      }
    }
    
    function applyFilters() {
      filteredTasks = allTasks.filter(task => {
        if (filters.priority && task.priority != filters.priority) return false;
        if (filters.hasDueDate && !task.due_date) return false;
        if (filters.project && task.project !== filters.project) return false;
        return true;
      });
      
      // Update stats
      document.getElementById('total-count').textContent = filteredTasks.length;
      document.getElementById('category-count').textContent = categories.length;
      
      renderViews();
    }
    
    function setView(view) {
      currentView = view;
      
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      document.getElementById('kanban-view').classList.toggle('active', view === 'kanban');
      document.getElementById('list-view').classList.toggle('active', view === 'list');
    }
    
    function renderViews() {
      renderKanban();
      renderList();
    }
    
    function renderKanban() {
      const container = document.getElementById('kanban-view');
      
      // Group tasks by category
      const tasksByCategory = {};
      categories.forEach(cat => tasksByCategory[cat] = []);
      
      filteredTasks.forEach(task => {
        const cat = task.category || 'Uncategorized';
        if (!tasksByCategory[cat]) tasksByCategory[cat] = [];
        tasksByCategory[cat].push(task);
      });
      
      // Sort tasks within each category by priority
      Object.keys(tasksByCategory).forEach(cat => {
        tasksByCategory[cat].sort((a, b) => (a.priority || 3) - (b.priority || 3));
      });
      
      container.innerHTML = categories.map(category => {
        const tasks = tasksByCategory[category] || [];
        return `
          <div class="kanban-column" data-category="${escapeHtml(category)}">
            <div class="kanban-header">
              <div class="kanban-title">
                ${getCategoryIcon(category)} ${escapeHtml(category)}
              </div>
              <span class="kanban-count">${tasks.length}</span>
            </div>
            <div class="kanban-tasks">
              ${tasks.length > 0 ? tasks.map(task => renderKanbanTask(task)).join('') : 
                '<div class="empty-column">No tasks</div>'}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderKanbanTask(task) {
      const isOverdue = task.due_date && new Date(task.due_date) < new Date();
      
      return `
        <div class="kanban-task" onclick="openTask('${task.id}')" data-id="${task.id}">
          <div class="kanban-task-header">
            <div class="priority-dot priority-${task.priority || 3}"></div>
            <div class="kanban-task-text">${escapeHtml(task.text)}</div>
          </div>
          <div class="kanban-task-meta">
            ${task.project ? `<span class="task-tag project">${escapeHtml(task.project)}</span>` : ''}
            ${task.due_date ? `<span class="task-tag due ${isOverdue ? 'overdue' : ''}">${formatDue(task.due_date)}</span>` : ''}
            ${task.is_active ? `<span class="task-tag active">Active</span>` : ''}
          </div>
        </div>
      `;
    }
    
    function renderList() {
      const container = document.getElementById('list-view');
      
      // Group tasks by category
      const tasksByCategory = {};
      categories.forEach(cat => tasksByCategory[cat] = []);
      
      filteredTasks.forEach(task => {
        const cat = task.category || 'Uncategorized';
        if (!tasksByCategory[cat]) tasksByCategory[cat] = [];
        tasksByCategory[cat].push(task);
      });
      
      // Sort tasks within each category by priority
      Object.keys(tasksByCategory).forEach(cat => {
        tasksByCategory[cat].sort((a, b) => (a.priority || 3) - (b.priority || 3));
      });
      
      container.innerHTML = categories.map(category => {
        const tasks = tasksByCategory[category] || [];
        return `
          <div class="category-section" data-category="${escapeHtml(category)}">
            <div class="category-header" onclick="toggleCategory(this)">
              <div class="category-title">
                <span class="category-arrow">‚ñº</span>
                ${getCategoryIcon(category)} ${escapeHtml(category)}
                <span class="kanban-count">${tasks.length}</span>
              </div>
            </div>
            <div class="category-tasks">
              ${tasks.length > 0 ? tasks.map(task => renderListTask(task)).join('') : 
                '<div class="empty-column">No tasks in this category</div>'}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderListTask(task) {
      const isOverdue = task.due_date && new Date(task.due_date) < new Date();
      
      return `
        <div class="list-task" data-id="${task.id}">
          <div class="task-checkbox" onclick="event.stopPropagation(); completeTask('${task.id}')"></div>
          <div class="priority-dot priority-${task.priority || 3}"></div>
          <div class="list-task-content" onclick="openTask('${task.id}')">
            <div class="list-task-text">${escapeHtml(task.text)}</div>
            <div class="list-task-meta">
              ${task.project ? `<span class="task-tag project">${escapeHtml(task.project)}</span>` : ''}
              ${task.due_date ? `<span class="task-tag due ${isOverdue ? 'overdue' : ''}">${formatDue(task.due_date)}</span>` : ''}
              ${task.is_active ? `<span class="task-tag active">Active</span>` : ''}
            </div>
          </div>
          <div class="list-task-actions">
            <button class="action-btn" onclick="event.stopPropagation(); showCategoryMenu(this, '${task.id}')" title="Change category">üìÅ</button>
            <button class="action-btn" onclick="event.stopPropagation(); activateTask('${task.id}')" title="Add to Active">‚ö°</button>
          </div>
        </div>
      `;
    }
    
    function toggleCategory(header) {
      header.parentElement.classList.toggle('collapsed');
    }
    
    function getCategoryIcon(category) {
      const icons = {
        'Work': 'üíº',
        'Personal': 'üè†',
        'Health': 'üí™',
        'Finance': 'üí∞',
        'Learning': 'üìö',
        'Projects': 'üöÄ',
        'Errands': 'üèÉ',
        'Waiting': '‚è≥',
        'Uncategorized': 'üìã'
      };
      return icons[category] || 'üìÅ';
    }
    
    function formatDue(dateStr) {
      if (!dateStr) return '';
      const due = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      due.setHours(0, 0, 0, 0);
      
      const diff = Math.floor((due - today) / 86400000);
      
      if (diff < 0) return `${Math.abs(diff)}d overdue`;
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Tomorrow';
      if (diff < 7) return `${diff}d`;
      
      return due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    function openTask(id) {
      window.location.href = `tasks.html?task=${id}`;
    }
    
    async function completeTask(id) {
      try {
        await Tasks.complete(id);
        await loadTasks();
      } catch (err) {
        alert('Failed to complete task');
      }
    }
    
    async function activateTask(id) {
      try {
        await Tasks.update(id, { is_active: 1 });
        await loadTasks();
      } catch (err) {
        alert('Failed to activate task');
      }
    }
    
    let categoryDropdown = null;
    let categoryDropdownTaskId = null;
    
    function showCategoryMenu(btn, taskId) {
      // Remove existing dropdown
      if (categoryDropdown) {
        categoryDropdown.remove();
      }
      
      categoryDropdownTaskId = taskId;
      
      const dropdown = document.createElement('div');
      dropdown.className = 'category-dropdown visible';
      dropdown.innerHTML = categories.map(cat => `
        <div class="category-option" onclick="setTaskCategory('${taskId}', '${escapeHtml(cat)}')">${getCategoryIcon(cat)} ${escapeHtml(cat)}</div>
      `).join('');
      
      // Position near the button
      const rect = btn.getBoundingClientRect();
      dropdown.style.position = 'fixed';
      dropdown.style.top = `${rect.bottom + 4}px`;
      dropdown.style.left = `${rect.left}px`;
      
      document.body.appendChild(dropdown);
      categoryDropdown = dropdown;
      
      // Close on click outside
      setTimeout(() => {
        document.addEventListener('click', closeCategoryDropdown, { once: true });
      }, 10);
    }
    
    function closeCategoryDropdown() {
      if (categoryDropdown) {
        categoryDropdown.remove();
        categoryDropdown = null;
      }
    }
    
    async function setTaskCategory(taskId, category) {
      closeCategoryDropdown();
      try {
        await Tasks.update(taskId, { category: category === 'Uncategorized' ? null : category });
        await loadTasks();
      } catch (err) {
        alert('Failed to update category');
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>